% 方法と材料を述べる
% 今回の研究では、次のテクニックを使った。
% - RMSD
% - RMSF
% - Thermal conductivity by curp
%   - 熱流の理論式
%   - 熱伝導度の理論式
% - MD simulation
%   - AMBER
%   - PME
%   - NPgT
%   - NPT
%   - minimization
%   - equilibration
%   - production
%   - NVE

% アウトライン
% - 熱伝導度の理論を説明する
%   - 熱伝導度の計算方法を説明する
% - 熱伝導度を計算するための準備としての、分子動力学シミュレーションの方法を説明する
%   - エネルギー最小化
%   - 熱平衡化
%   - sampling
%   - NVE

\section{熱伝導度の解析}
% - 熱伝導度と熱流について述べる
本研究では、先行研究が示したEEN、\Delta EEN、r\Delta EENの概念\autocite{ishikura2015,ota_energy_2019,poudel_energy_2022}を
熱流解析に応用して、TRPV3の活性化と調節における構造的および機能的ダイナミクスを明らかにする。
なお、本研究の目的を達成するには熱流にこだわらずEnergy fluxやエネルギー伝導度を用いた方法を用いてもよいが
熱流から計算される熱伝導度は、実験的に測定することができるというメリットがあるため、本研究では熱流を用いた手法を用いることにした。

先行研究でエネルギー流ではなくエネルギー伝導度を用いていたことにならい、本研究でも熱流ではなく熱伝導度を用いて解析した。
ここで、熱伝導度と熱流について簡単に説明する。

% TODO: 改善。
熱伝導度$\lambda$は平衡状態において。

\begin{equation}
  \label{eq:thermal_conductivity}
  \lambda = \frac{1}{3Vk_B T^2} \int_{0}^{\infty} \left\langle
    \bm{h}(0) \cdot \bm{h}(t)
  \right\rangle dt
\end{equation}

ここで$\mathbf{h}$は熱流を表す。\autocite{mcquarrie_statistical_2000}

熱流$\mathbf{h}$をこう定義する。

\begin{equation}
  \label{eq:heat_flow}
  \bm{h} \equiv \frac{d}{dt} \left\{
    \sum_{i=1}^{N} \bm{r}_i \cdot E_i
  \right\} = \sum_{i=1}^{N} \left\{
    \frac{d\bm{r_i}}{dt}E_i + \bm{r_i}\frac{dE_i}{dt}
  \right\}
\end{equation}

ここで、右辺の $\frac{dE_i}{dt}$は

\begin{equation}
  \label{time_derivative_of_energy}
  \frac{dE_i}{dt} = \sum_{j=1}^{N} \frac{1}{2} \bf{F}_{ij} \cdot (\bf{v}_i + \bf{v}_j)
\end{equation}

と展開できる\autocite{leitner_mapping_2018}。
また、タンパク質中の原子の運動は著しく制限されるため$\frac{d\bm{r_i}}{dt}E_{i}$が十分小さいと考えて無視すれば、
式\ref{eq:heat_flow}は次のように変形できる。\autocite{yamatoComputationalStudyThermal2022,oai:nagoya.repo.nii.ac.jp:02007698}

\begin{align}
  % \label{eq:heat_flow_expanded}
  \bm{h} &= \sum_{i=1}^{N} \left\{
              \bm{r_i}\sum_{j=1, j \neq i }^{N} \frac{1}{2} \bf{F}_{ij} \cdot (\bf{v}_i + \bf{v}_j)
            \right\} \\
         &= \sum_{i=1}^{N} \sum_{j>i}^{N}
              (\bm{r_i} - \bm{r_j}) \frac{1}{2} \bf{F}_{ij} \cdot (\bf{v}_i + \bf{v}_j) \\
         &= \sum_{(i, j)}
              (\bm{r_i} - \bm{r_j}) \frac{1}{2} \bf{F}_{ij} \cdot (\bf{v}_i + \bf{v}_j) \\
         &= \sum_{(i, j)}
              \bm{h}_{ij}
\end{align}

ここで、一行目から二行目への式変形には $\bf{F}_{ij} = - \bf{F}_{ij}$を用いた。
ここで得られた熱流$\bm{h}_{ij}$を使い、残基A、B間の熱流$\bm{h}{AB}$を次のように定義する。

\begin{equation}
  \label{eq:heat_flow_between_residues}
  \bm{h}_{AB} = \sum_{\substack{(i, j) \\ i \in \rm{A}, j \in \rm{B}}} \bm{h}_{ij}
\end{equation}

最後に、この残基間熱流 $\bm{h}_{AB}$を用いて、残基間熱伝導度$\lambda_{AB}$を次のように定義する。

\begin{equation}
  \label{eq:thermal_conductivity_between_residues}
  \lambda_{AB} = \frac{1}{3Vk_B T^2} \int_{0}^{\infty} \left\langle
    \bm{h}_{AB}(0) \cdot \bm{h}_{AB}(t)
  \right\rangle dt
\end{equation}

\section{分子動力学シミュレーション}

熱伝導度を計算するためには、NVEアンサンブルでの分子動力学シミュレーションを行う必要がある。
そのため本研究では、モデリング、構造最適化、熱平衡化、サンプリング、解析の5つのステップを踏んで熱伝導度の計算を行った。

\subsection{モデリング}
開構造として7MIO、% FLOW_ID = 13, structure_id = 11
閉構造として7MIN  % FLOW_ID = 11, structure_id = 9 
を用いた。\autocite{noauthor_7mio_nodate, noauthor_7min_nodate, nadezhdinStructuralMechanismHeatinduced2021}
それぞれの構造について、CHARMM-GUIのInput generator\autocite{jo_charmmgui_2008, lee_charmm-gui_2016}を用いて、リン脂質二重膜にタンパク質を挿入して、シミュレーションボックスを作成した。
なお、今後開構造の7MIOを「\openFortyTwo」、閉構造の7MINを「\closeFortyTwo」と呼ぶことにする。

CHARMM-GUIを用いて、次のように系を作成した。
まず、\openFortyTwo は残基番号77から112までの残基はモデリングされていなかったため、残基番号113以降の構造情報のみを用いた。
次に、PDBデータに含まれていたタンパク質以外の分子についてはあらかじめすべて除去した。
また、両方のモデルについて、タンパク質分子に対して pH 7.0 でプロトン化した。
続けて、作成したモデルをリン脂質二重層に挿入した。
% メモ: 脂質の名前に自信がない。
% メモ: newcommandで定義しているので、後で変更するときは定義場所だけ変更すればよい。
% POPC
%  - 1-palmitoyl-2-oleoyl-sn-glycero-3-phosphocholine, https://en.wikipedia.org/wiki/POPC
% POPE
%  - 1-palmitoyl-2-oleoyl-sn-glycero-3-phosphoethanolamine, https://avantilipids.com/product/850757
%  - palmitoyloleoyl-phosphatidylethanolamine, https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1305115/
%  - 1-Palmitoyl-2-oleoylphosphatidylethanolamine, https://pubchem.ncbi.nlm.nih.gov/compound/1-Palmitoyl-2-oleoylphosphatidylethanolamine
%  - 1-palmitoyl-2-oleoyl-phosphatidylethanolamine, https://pubs.acs.org/doi/10.1021/bi060937y
脂質二重層の構成分子は、\molNamePOPC (POPC)、\molNamePOPE (POPE)、\molNameCHOL (CHOL)を使い、これらの分子をPOPC:POPE:CHOL=2:1:1の比率で混合した。
最後に、水分子とNaClイオンを加えて系の電荷を中和した。NaClイオンは0.15 Mの濃度になるように追加した。
シミュレーションパッケージAMBER 22\autocite{case_amber_2023}を使ったため、ポテンシャル関数としてAMBER\autocite{pearlman_amber_1995}を利用した。
ポテンシャル関数の各パラメータは、
タンパク質の原子にはff19SB\autocite{tian_ff19sb_2020}、
脂質の原子にはLipid21\autocite{dickson_lipid21_2022}、
水分子にはOPC水モデル\autocite{izadi_building_2014}を用いた。
系には3次元の周期境界条件を設定した。
系を作成した後の系の大きさを表\ref{tab:system_size}に示す。

\begin{table}[!ht]
  \centering
  \caption{シミュレーションに用いた系の大きさ}
  \begin{tabular}{lll}
    \hline
    モデル名        & 原子数  & ボックスの大きさ(x, y, z) \\
    \hline 
    \openFortyTwo  & 1183281 & 250.19627, 250.19627, 161.529 \\ 
    \closeFortyTwo & 1206767 & 250.14921, 250.14921, 164.691 \\ 
  \end{tabular}
  \label{tab:system_size}
\end{table}

\subsection{シミュレーション}
作成したモデルは、以下の手続きによりシミュレーションを行った。シミュレーションには、Particle Mesh Ewald法を用いた。
% 粒子として取り扱う距離を cut = 9 [A]とした。

はじめに、構造最適化を行った。構造最適化は3つのステップに分けて行った。
最初のステップでは、水以外の原子に対してrestraintをかけて、水の構造、並びを最適化した。
次のステップでは、タンパク質の原子に対してrestraintをかけて、水と脂質の構造を最適化した。
最後のステップでは、すべてのrestraintを外して、全体の構造を最適化した。
各ステップにおいて、最初の2500ステップで再急降下法によるエネルギー最小化を行い、次の2500ステップで共役勾配法によるエネルギー最小化を行った。

次に、熱平衡化を行った。
熱平衡化は大きく分けて2つのステップに分けて行った。
% 1. T = 10K で開始。NVT. 初期速度はマクスウェル分布で与える。1.mdinと2.mdinを使って、dt = 1 fsで125000 + 125000 = 250 psのシミュレーションの中で10 K -> 300Kまで上げる。
% 2. NPgT. 125000 steps, dt = 1 fs. 3.mdin
% 3. NPgT. 250000 steps, dt = 2 fs. 4.mdin
% 4. 
初めに、NVTアンサンブルで系の温度を上げた。初期速度は温度$T = 10 \rm{[K]}$のマクスウェル分布に従って与え、250 $\rm{ps}$で温度を$T = 315.15 \rm{[K]}$まで上昇させた。
次に、NP\gamma Tアンサンブルで平衡化を行った。
NP\gamma Tアンサンブルでは、温度、膜の表面張力、系の総数が一定になるようにシミュレーションを行う。% TODO: NPgTの説明を書く
詳細なシミュレーション条件は、表\ref{tab:simulation_condition}に示す。

% TODO: restraintについて記述する。
\begin{table}[!ht]
  \centering
  \caption{シミュレーション条件}
  \begin{tabular}{lllll}
    \hline
    ステップ & \Delta t [fs] & 時間 [ps] & アンサンブル & 温度 [T] \\
    \hline
    1       & 1              & 125       & NVT         & 10 $\rightarrow$ 100 \\
    2       & 1              & 125       & NVT         & 100 $\rightarrow$ 315.15 \\
    3       & 1              & 125       & NP\gamma T  & 315.15 \\
    4       & 2              & 500       & NP\gamma T  & 315.15 \\
    5       & 2              & 500       & NP\gamma T  & 315.15 \\
    6       & 2              & 500       & NP\gamma T  & 315.15 \\
  \end{tabular}
  \label{tab:simulation_condition}
\end{table}

続いて、NP\gamma Tシミュレーションによるサンプリングを行った。
熱平衡化の最後のステップと同じ、ただしrestraintを外した状態で10 nsのシミュレーションを実行した。
最後の5 nsの中で、各500 psごとに座標と速度を保存し、次のNVEのシミュレーションの初期状態として用いた。

最後にNVEシミュレーションによるサンプリングを行った。
初期状態として、NP\gamma Tシミュレーションによるサンプリングで得られた座標と速度を用いた。
保存した座標と速度のうち、5つを使って\Delta t = 1 fs、1 nsのシミュレーションを実行した。
シミュレーション中、各10 fsごとにトラジェクトリを保存した。

\section{熱伝導度の解析}

NVEシミュレーションによって得られたトラジェクトリを用いて、熱伝導度を計算した。
熱伝導度の計算には、CURP\autocite{ishikura_energy_2015,ota_energy_2019,yamatoComputationalStudyThermal2022,wangSiteselectiveHeatCurrent2023} を用いた。

熱伝導度を計算する残基ペアは次のように選んだ。まず、残基間最近接距離が6\AA 以内の非共有結合を形成する残基同士をペアとして選んだ。
共有結合を含めた計算を行おうとすると、共有結合に基づく振動を考慮に入れるために、分子動力学シミュレーションの時間刻みを小さくする必要がある。
しかし今回は計算時間を短縮するため、時間刻みを小さくすることができなかった。そのため、本研究においてはペアとして共有結合をとる残基を含めない。
次に、用いた構造がホモ四量体だったので、計算時間を短縮するため、主鎖Aに属する残基同士のペアと主鎖Aと主鎖Bに属する残基同士のペアだけ抽出した。
最後に、 \openFortyTwo と\closeFortyTwo に共通するペアだけを選び、これを計算対象とした。

\openFortyTwo と\closeFortyTwo における熱伝導度の変化を計算するために、

\begin{equation}
  \label{eq:thermal_conductivity_difference}
  \Delta \lambda_{\rm{AB}} = \lambda_{\rm{AB, open}} - \lambda_{\rm{AB, close}}
\end{equation}

を計算した。
熱流ネットワークは残基間相互作用や情報伝達の行われ方を表すため、
状態間の$\Delta \lambda_{\rm{AB}}$の絶対値が大きいペアは、状態変化を起こす、もしくは、状態変化によって大きく変化する残基間の相互作用を表すと考えられる。

\subsection{CURPの改良}\label{sec:curp}

CURPは、AMBERの原子座標、速度の二つを入力として受け取り、二体力を算出してから熱流を演算し、出力する。
この一連の流れのうち、約8割の計算時間は二体力と座標の変位の演算に充てられる。
二体力の演算時間は原子ペア数に比例して増えるため、今回の研究のような大規模な系では二体力の演算にかかる時間を短縮する必要がある。
従来は系の大きさを小さく保ったり計算する範囲を狭めたりしていたが、今回の研究では避けられなくなってしまったため、
二体力と座標の変位の演算時間を短縮するための変更を行った。

具体的には、従来のCURPでは、二体力の計算と座標の変位の演算を別々に分けていた。
Fortran 90で記述された二体力計算ルーチンと座標の変位計算ルーチンがそれぞれ呼び出されていた。
このルーチンを統合し、二体力の計算と座標の変位の計算を同時に行うようにした。

% >>> optimized_times = [13.76848,13.70891,13.71280,13.76977,12.39074,13.05582,12.89777,12.90534,13.34440,13.36865]
% >>> original_times = [18.69356,18.69938,18.46984,18.51525,18.72938,18.57986,18.74573,18.39699,18.31260,18.28664]
% >>> sum(optimized_times)/sum(original_times)
% 0.7168377930491325
実は原理上、二体力の計算を行う中で座標の変位の計算を行うため、
演算途中の座標の変位を保存しておくだけで達成できたため、大幅な計算時間の短縮ができた。
最適化前と後で10回、テスト以外に負荷のない状態の同じ機材を用いてテスト計算を行った。
まず、最適化前と後で、計算結果に差がないことを確認した。
また、I/O待ち時間やセットアップ時間を除いた時間を比較すると、計算時間を平均39\%削減した。

本研究では、この最適化を施したCURPを用いて熱伝導度を計算した。
また、最適化のパッチをCURPの公式リポジトリ https://github.com/yamatolab/current-calculations-for-proteins/ に提出し、内容を反映させた。
